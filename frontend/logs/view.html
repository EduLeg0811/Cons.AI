<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logs Viewer</title>
  <script src="../config.js"></script>
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #14161a;
      --text: #e8eaf0;
      --muted: #a7aebb;
      --accent: #62a0ea;
      --ok: #6fcf97;
      --err: #ff6b6b;
      --border: #22262c;
    }
    html, body {height:100%;}
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap {max-width: 1200px; margin: 0 auto; padding: 16px;}
    h1 {font-size: 18px; margin: 0 0 10px; font-weight: 600;}

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 8px;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .toolbar .left {display:flex; gap:8px; align-items:center;}

    input[type="text"], select {
      background: #0f1115;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 8px 10px;
      outline: none;
    }
    input[type="checkbox"] { width: 16px; height: 16px; }

    button {
      background: var(--accent);
      color: #04121e;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary { background: #233042; color: var(--text); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    thead th {
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .02em;
      background: #101217;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      font-size: 13px;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    tr:hover td { background: #11141a; }

    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#1a2432; color:#c5d3e8; font-size:11px; }
    mark { background: #393; color: #fff; padding: 0 2px; border-radius: 2px; }

    .counts { color: var(--muted); font-size: 12px; margin: 8px 0; }
    .col-adv { display: table-cell; }
    .simple .col-adv { display: none; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; }
    .muted { color: var(--muted); }
    .status-ok { color: var(--ok); }
    .status-err { color: var(--err); }

    @media (max-width: 800px) {
      .toolbar { grid-template-columns: 1fr 1fr 1fr; }
      .toolbar .left { grid-column: 1 / -1; }
      thead .col-adv { display: none; }
      .col-adv { display: none !important; }
    }
    /* Feedback highlight */
    .fb-banner { margin: 12px 0; padding: 12px; border-radius: 10px; border:1px solid #2b3a4e; background: linear-gradient(180deg,#0f1a24,#0c141c); box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
    .fb-item { background:#0e1520; border:1px solid #233042; border-radius:8px; padding:10px; color:#e8eaf0; }
    .fb-meta { font-size: 12px; color:#a7aebb; margin-bottom:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .fb-text { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Logs Viewer</h1>
    <div id="fbTop" class="fb-banner" style="display:none;">
      <h2>Último Feedback recebido</h2>
      <div id="fbBox" class="fb-item">
        <div class="fb-meta"><span id="fbWhen"></span><span class="pill">feedback_message</span></div>
        <div id="fbText" class="fb-text"></div>
      </div>
    </div>
    <div class="toolbar">
      <div class="left">
        <button id="btnRefresh">Atualizar</button>
        <label class="mono"><input type="checkbox" id="chkAuto"> Auto (5s)</label>
        <label class="mono"><input type="checkbox" id="chkMode"> Modo Completo</label>
      </div>
      <input type="text" id="txtSearch" placeholder="Busca (substring, sem regex)">
      <select id="selSort">
        <option value="desc">Recentes primeiro</option>
        <option value="asc">Antigos primeiro</option>
      </select>
      <select id="selLimit">
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="500" selected>500</option>
      </select>
      <button id="btnClear" class="secondary">Zerar dia</button>
      <button id="btnClearAll" class="secondary">Limpar tudo</button>
    </div>

    <div class="counts" id="counts"></div>

    <table id="tbl" class="simple">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Event</th>
          <th>Module</th>
          <th class="col-adv">Page</th>
          <th>Value</th>
          <th>Geo</th>
          <th class="col-adv">IP</th>
          <th class="col-adv">Origin</th>
          <th class="col-adv">UA</th>
          <th class="col-adv">chat_id</th>
          <th class="col-adv">session_id</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td class="muted" colspan="11">Carregando…</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // [logs:view] core state
    const state = {
      timer: null,
      data: [],
      filter: '',
      sort: 'desc',
      limit: 500,
      complete: false,
    };

    const el = {
      tbody: document.getElementById('tbody'),
      counts: document.getElementById('counts'),
      fbTop: document.getElementById('fbTop'),
      fbBox: document.getElementById('fbBox'),
      fbText: document.getElementById('fbText'),
      fbWhen: document.getElementById('fbWhen'),
      btnRefresh: document.getElementById('btnRefresh'),
      chkAuto: document.getElementById('chkAuto'),
      chkMode: document.getElementById('chkMode'),
      txtSearch: document.getElementById('txtSearch'),
      selSort: document.getElementById('selSort'),
      selLimit: document.getElementById('selLimit'),
      btnClear: document.getElementById('btnClear'),
      btnClearAll: document.getElementById('btnClearAll'),
      table: document.getElementById('tbl'),
    };

    console.log('[logs:view] load');
    try { if (window.logEvent) window.logEvent({ event: 'logs_view_open', module: 'logs', page: '/logs/view' }); } catch {}

    function safeStr(v) { return (v === undefined || v === null) ? '' : String(v); }

    function highlight(text, query) {
      const t = safeStr(text);
      const q = safeStr(query).toLowerCase();
      if (!q) return t;
      let out = '';
      let i = 0;
      let j;
      const lower = t.toLowerCase();
      while ((j = lower.indexOf(q, i)) !== -1) {
        out += t.slice(i, j) + '<mark>' + t.slice(j, j + q.length) + '</mark>';
        i = j + q.length;
      }
      out += t.slice(i);
      return out;
    }

    function geoToStr(geo) {
      if (!geo) return '';
      const parts = [geo.city, geo.region, geo.country].filter(Boolean);
      return parts.join(', ');
    }

    // Friendly timestamp format: DD/MM/YYYY - HH:MM
    function formatTs(ts) {
      const s = safeStr(ts);
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return s;
      const pad = (n) => String(n).padStart(2, '0');
      const day = pad(d.getDate());
      const mon = pad(d.getMonth() + 1);
      const year = d.getFullYear();
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      return `${day}/${mon}/${year} - ${hh}:${mm}`;
    }

    function renderFeedbackHighlight() {
      if (!Array.isArray(state.data) || !state.data.length) {
        el.fbTop.style.display = 'none';
        el.fbText.textContent = '';
        el.fbWhen.textContent = '';
        return;
      }
      let latest = null;
      for (let i = state.data.length - 1; i >= 0; i--) {
        const r = state.data[i] || {};
        if (safeStr(r.event) === 'feedback_message' && safeStr(r.value)) { latest = r; break; }
      }
      if (!latest) {
        el.fbTop.style.display = 'none';
        el.fbText.textContent = '';
        el.fbWhen.textContent = '';
        return;
      }
      el.fbTop.style.display = '';
      el.fbText.textContent = safeStr(latest.value);
      el.fbWhen.textContent = formatTs(latest._server_ts || latest.ts || '');
    }

    function renderRows(rows) {
      const q = state.filter;
      if (!rows.length) {
        el.tbody.innerHTML = '<tr><td class="muted" colspan="11">Nenhum evento.</td></tr>';
        return;
      }
      const html = rows.map(r => {
        const ts = formatTs(r._server_ts);
        const evt = safeStr(r.event);
        const mod = safeStr(r.module || r.module_label);
        const page = safeStr(r.page);
        const val = safeStr(r.value);
        const geo = geoToStr(r._geo);
        const ip = safeStr(r._client_ip);
        const origin = safeStr(r.origin);
        const ua = safeStr(r._user_agent);
        const chat = safeStr(r.chat_id);
        const sid = safeStr(r.session_id);
        return `<tr>
          <td class="mono">${highlight(ts, q)}</td>
          <td><span class="pill">${highlight(evt, q)}</span></td>
          <td>${highlight(mod, q)}</td>
          <td class="col-adv mono">${highlight(page, q)}</td>
          <td>${highlight(val, q)}</td>
          <td>${highlight(geo, q)}</td>
          <td class="col-adv mono">${highlight(ip, q)}</td>
          <td class="col-adv">${highlight(origin, q)}</td>
          <td class="col-adv">${highlight(ua, q)}</td>
          <td class="col-adv mono">${highlight(chat, q)}</td>
          <td class="col-adv mono">${highlight(sid, q)}</td>
        </tr>`;
      }).join('');
      el.tbody.innerHTML = html;
    }

    function applyFilters() {
      console.log('[logs:view] filtros/sort');
      let rows = state.data.slice();
      // sort
      rows.sort((a, b) => {
        const ta = Date.parse(a._server_ts || 0) || 0;
        const tb = Date.parse(b._server_ts || 0) || 0;
        return state.sort === 'desc' ? tb - ta : ta - tb;
      });
      // filter
      const q = state.filter.toLowerCase();
      if (q) {
        rows = rows.filter(r => {
          const blob = (
            safeStr(r._server_ts) + ' ' + safeStr(r.event) + ' ' + safeStr(r.module) + ' ' +
            safeStr(r.page) + ' ' + safeStr(r.value) + ' ' + safeStr(geoToStr(r._geo)) + ' ' +
            safeStr(r._client_ip) + ' ' + safeStr(r.origin) + ' ' + safeStr(r._user_agent) + ' ' +
            safeStr(r.chat_id) + ' ' + safeStr(r.session_id)
          ).toLowerCase();
          return blob.indexOf(q) !== -1;
        });
      }
      // exclude page_view in simple mode
      if (!state.complete) {
        rows = rows.filter(r => (r.event || '') !== 'page_view');
      }
      renderRows(rows);
      el.counts.textContent = `Eventos: ${rows.length} (total lido: ${state.data.length})`;
    }

    async function fetchLogs() {
      const u = `/logs?format=ndjson&limit=${encodeURIComponent(state.limit)}`;
      console.log('[logs:view] fetch', u);
      try {
        const res = await fetch(u, { cache: 'no-store', headers: { 'Accept': 'application/x-ndjson' }});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const lines = text.trim() ? text.trim().split('\n') : [];
        const data = [];
        for (const line of lines) {
          try { data.push(JSON.parse(line)); }
          catch { /* ignore malformed */ }
        }
        state.data = data;
        renderFeedbackHighlight();
        applyFilters();
      } catch (err) {
        console.log('[logs:view] fetch error', err);
        el.tbody.innerHTML = `<tr><td class="status-err" colspan="11">Falha ao buscar logs: ${safeStr(err.message || err)}</td></tr>`;
        el.counts.textContent = '';
      }
    }

    function startAuto() {
      stopAuto();
      state.timer = setInterval(fetchLogs, 5000);
    }
    function stopAuto() {
      if (state.timer) { clearInterval(state.timer); state.timer = null; }
    }

    // Events
    el.btnRefresh.addEventListener('click', () => { try { if (window.logEvent) window.logEvent({ event: 'logs_view_refresh', module: 'logs', meta: { limit: state.limit, filter: state.filter, sort: state.sort, complete: state.complete } }); } catch {} fetchLogs(); });
    el.chkAuto.addEventListener('change', () => {
      if (el.chkAuto.checked) startAuto(); else stopAuto();
    });
    el.chkMode.addEventListener('change', () => {
      state.complete = el.chkMode.checked;
      if (state.complete) el.table.classList.remove('simple');
      else el.table.classList.add('simple');
    });
    el.txtSearch.addEventListener('input', (e) => { state.filter = e.target.value; applyFilters(); });
    el.selSort.addEventListener('change', (e) => { state.sort = e.target.value; applyFilters(); });
    el.selLimit.addEventListener('change', (e) => { state.limit = parseInt(e.target.value, 10) || 500; fetchLogs(); });
    el.btnClear.addEventListener('click', async () => {
      console.log('[logs:view] clear');
      try {
        const res = await fetch('/logs/clear', { method: 'DELETE' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        await fetchLogs();
      } catch (err) {
        el.tbody.innerHTML = `<tr><td class="status-err" colspan="11">Falha ao limpar: ${safeStr(err.message || err)}</td></tr>`;
      }
      try { if (window.logEvent) window.logEvent({ event: 'logs_clear', module: 'logs' }); } catch {}
    });

    // Limpar todos os logs (todas as datas)
    el.btnClearAll.addEventListener('click', async () => {
      console.log('[logs:view] clear_all');
      try {
        const res = await fetch('/logs/clear_all', { method: 'DELETE' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        await fetchLogs();
      } catch (err) {
        el.tbody.innerHTML = `<tr><td class="status-err" colspan="11">Falha ao limpar tudo: ${safeStr(err.message || err)}</td></tr>`;
      }
      try { if (window.logEvent) window.logEvent({ event: 'logs_clear_all', module: 'logs' }); } catch {}
    });

    // initial
    fetchLogs();
  </script>
</body>
</html>

